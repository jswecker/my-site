---
const title = "Party Jukebox ‚Äî Request";
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
  </head>
  <body class="min-h-screen bg-neutral-950 text-neutral-100">
    <main class="mx-auto max-w-xl p-4">
      <h1 class="text-2xl font-bold">Party Jukebox</h1>
      <p class="text-neutral-300 mt-1">Search a song, request it, and vote the best ones up.</p>

      <section class="mt-6">
        <label class="block text-sm text-neutral-300">Search</label>
        <div class="mt-2 flex gap-2">
          <input id="q" class="w-full rounded-lg bg-neutral-900 p-3 outline-none ring-1 ring-neutral-800"
            placeholder="Type a song or artist (min 3 chars)" />
          <button id="btnSearch" class="rounded-lg bg-white px-4 text-neutral-900 font-semibold">Search</button>
        </div>
        <div id="results" class="mt-3 space-y-2"></div>
      </section>

      <section class="mt-8">
        <div class="flex items-end justify-between">
          <h2 class="text-xl font-semibold">Requests</h2>
          <span class="text-xs text-neutral-400">Tap üëç to vote</span>
        </div>
        <div id="requests" class="mt-3 space-y-2"></div>
      </section>
    </main>

    <script type="module">
      const $ = (id) => document.getElementById(id);

      const votedKey = "jukebox_voted_ids";
      const getVoted = () => new Set(JSON.parse(localStorage.getItem(votedKey) || "[]"));
      const saveVoted = (set) => localStorage.setItem(votedKey, JSON.stringify([...set]));

      async function search() {
	  const q = $("q").value.trim();
	  if (q.length < 3) { $("results").innerHTML = ""; return; }

	  $("results").innerHTML = `<div class="text-neutral-400 text-sm">Searching‚Ä¶</div>`;

	  try {
	    const url = `https://itunes.apple.com/search?term=${encodeURIComponent(q)}&entity=song&limit=10`;
	    const r = await fetch(url, { mode: "cors" });

	    if (!r.ok) {
	      $("results").innerHTML = `<div class="text-red-300 text-sm">Search failed (${r.status}). Try again.</div>`;
	      return;
	    }

	    const data = await r.json();

	    const results = (data.results ?? []).map(t => ({
	      trackId: t.trackId,
	      trackName: t.trackName,
	      artistName: t.artistName,
	      collectionName: t.collectionName,
	      artworkUrl100: t.artworkUrl100,
	      trackTimeMillis: t.trackTimeMillis,
	    }));

	    if (results.length === 0) {
	      $("results").innerHTML = `<div class="text-neutral-400 text-sm">No results.</div>`;
	      return;
	    }

	    // Render WITHOUT putting raw JSON into HTML attributes (safer)
	    $("results").innerHTML = results.map((t, i) => `
	      <button class="w-full text-left rounded-lg bg-neutral-900 ring-1 ring-neutral-800 p-3 hover:bg-neutral-800"
		      data-idx="${i}">
		<div class="font-semibold">${escapeHtml(t.trackName)}</div>
		<div class="text-sm text-neutral-300">${escapeHtml(t.artistName)}${t.collectionName ? " ‚Ä¢ " + escapeHtml(t.collectionName) : ""}</div>
	      </button>
	    `).join("");

	    [...$("results").querySelectorAll("button[data-idx]")].forEach(btn => {
	      btn.addEventListener("click", async () => {
		const track = results[Number(btn.getAttribute("data-idx"))];
		$("results").innerHTML = `<div class="text-neutral-400 text-sm">Submitting‚Ä¶</div>`;

		const requestedBy = ""; // optional: prompt for name
		const resp = await fetch("/api/request", {
		  method: "POST",
		  headers: { "Content-Type": "application/json" },
		  body: JSON.stringify({ ...track, requestedBy })
		});

		if (!resp.ok) {
		  const txt = await resp.text().catch(() => "");
		  $("results").innerHTML = `<div class="text-red-300 text-sm">Request failed. ${escapeHtml(txt)}</div>`;
		  return;
		}

		$("results").innerHTML = `<div class="text-green-300 text-sm">Requested: ${escapeHtml(track.trackName)} ‚Äî ${escapeHtml(track.artistName)}</div>`;
		await refreshRequests();
	      });
	    });

	  } catch (err) {
	    console.error(err);
	    $("results").innerHTML = `
	      <div class="text-red-300 text-sm">
		Search blocked (CORS/network). If this keeps happening, switch to the Deezer fallback.
	      </div>
	    `;
	  }
	}

// Simple HTML escape (prevents weird rendering / injection)
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (c) => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
  }[c]));
}


      async function refreshRequests() {
        const r = await fetch("/api/requests?limit=50");
        const data = await r.json();
        const voted = getVoted();

        $("requests").innerHTML = (data.results || []).map(row => {
          const spotifySearch = `https://open.spotify.com/search/${encodeURIComponent(row.track_name + " " + row.artist_name)}`;
          const disabled = voted.has(row.id);
          return `
            <div class="rounded-lg bg-neutral-900 ring-1 ring-neutral-800 p-3 flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold truncate">${row.track_name}</div>
                <div class="text-sm text-neutral-300 truncate">${row.artist_name}${row.album_name ? " ‚Ä¢ " + row.album_name : ""}</div>
                <a class="text-xs text-neutral-400 underline" href="${spotifySearch}" target="_blank" rel="noreferrer">Open Spotify search</a>
              </div>
              <div class="flex items-center gap-2 shrink-0">
                <span class="text-sm text-neutral-200 font-semibold">${row.votes}</span>
                <button class="vote rounded-lg px-3 py-2 font-semibold ${disabled ? "bg-neutral-800 text-neutral-500" : "bg-white text-neutral-900"}"
                        data-id="${row.id}" ${disabled ? "disabled" : ""}>üëç</button>
              </div>
            </div>
          `;
        }).join("");

        [...document.querySelectorAll("button.vote")].forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            const voted = getVoted();
            if (voted.has(id)) return;

            voted.add(id); saveVoted(voted);
            await fetch("/api/vote", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ id }) });
            await refreshRequests();
          });
        });
      }

      $("btnSearch").addEventListener("click", search);
      $("q").addEventListener("keydown", (e) => { if (e.key === "Enter") search(); });

      // Party-friendly polling
      refreshRequests();
      setInterval(refreshRequests, 10000);
    </script>
  </body>
</html>

