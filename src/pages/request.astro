---
const title = "Party Jukebox ‚Äî Request";
import Layout from "../layouts/Layout.astro";
---
<Layout>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <style>
      :root { color-scheme: dark; }
    </style>
  </head>

  <body class="min-h-screen text-neutral-100 bg-[#0b0f0e]">
    <!-- Spotify-ish backdrop -->
    <div class="fixed inset-0 -z-10">
      <div class="absolute inset-0 bg-[#0b0f0e]"></div>
      <div
        class="absolute -top-40 left-1/2 h-[520px] w-[920px] -translate-x-1/2 rounded-full blur-3xl opacity-30"
        style="background: radial-gradient(circle at 50% 50%, rgba(29,185,84,0.35), rgba(0,0,0,0));"
      ></div>
      <div class="absolute inset-0 bg-gradient-to-b from-transparent via-black/20 to-black/60"></div>
    </div>

    <main class="mx-auto max-w-2xl px-4 pb-16 pt-8">
      <!-- Header -->
      <header class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <div class="inline-flex items-center gap-2 rounded-full bg-white/5 px-3 py-1 ring-1 ring-white/10">
            <span class="inline-block h-2 w-2 rounded-full bg-[#1DB954]"></span>
            <span class="text-xs font-semibold tracking-wide text-neutral-200">PARTY JUKEBOX</span>
          </div>

          <h1 class="mt-4 text-3xl sm:text-4xl font-extrabold tracking-tight">
            Request a song
          </h1>
          <p class="mt-2 text-sm text-neutral-300">
            Search a track, request it, and vote the best ones up.
          </p>
        </div>

        <div class="flex flex-col gap-2">
          <a
            href="/"
            class="rounded-full bg-white/5 px-4 py-2 text-sm font-semibold text-neutral-200 ring-1 ring-white/10 hover:bg-white/10"
          >
            Home
          </a>

          <a
            href="/screen"
            class="rounded-full bg-[#1DB954] px-4 py-2 text-sm font-extrabold text-black hover:brightness-110 active:brightness-95"
          >
            View Screen ‚Üí
          </a>
        </div>
      </header>

      <!-- Toast / status -->
      <div id="toast" class="mt-6 hidden rounded-2xl p-4 text-sm ring-1"></div>

      <!-- Search card -->
      <section class="mt-6 rounded-3xl bg-white/5 p-6 ring-1 ring-white/10 backdrop-blur">
        <div class="flex items-end justify-between gap-4">
          <div>
            <label for="q" class="block text-sm font-semibold text-neutral-200">Search</label>
            <p class="mt-1 text-xs text-neutral-400">Type a song or artist (min 3 chars)</p>
          </div>
          <div class="text-xs text-neutral-500">Powered by iTunes Search</div>
        </div>

        <!-- BIG search row -->
        <div class="mt-4 flex flex-col sm:flex-row gap-3">
          <div class="relative w-full">
            <span class="pointer-events-none absolute left-5 top-1/2 -translate-y-1/2 text-neutral-500 text-lg">‚åï</span>
            <input
              id="q"
              class="w-full rounded-full bg-black/30 py-4 pl-12 pr-5 text-base sm:text-lg text-neutral-100 outline-none
                     ring-1 ring-white/10 placeholder:text-neutral-500 focus:ring-[#1DB954]/55"
              placeholder="Search songs, artists‚Ä¶"
              autocomplete="off"
            />
          </div>

          <div class="flex gap-3">
            <button
              id="btnSearch"
              class="rounded-full bg-[#1DB954] px-8 py-4 text-base sm:text-lg font-extrabold text-black
                     hover:brightness-110 active:brightness-95"
              type="button"
            >
              Search
            </button>

            <button
              id="btnRefresh"
              type="button"
              class="rounded-full bg-white/10 px-6 py-4 text-base sm:text-lg font-extrabold text-neutral-100
                     ring-1 ring-white/15 hover:bg-white/15 active:bg-white/10"
            >
              ‚Üª Refresh
            </button>
          </div>
        </div>

        <div id="results" class="mt-5 space-y-2"></div>
      </section>

      <!-- Requests list -->
      <section class="mt-8">
        <div class="flex items-end justify-between">
          <h2 class="text-xl font-extrabold tracking-tight">Requests</h2>
          <span class="text-xs text-neutral-400">Tap üëç to vote</span>
        </div>

        <div id="requests" class="mt-4 space-y-3"></div>
      </section>
    </main>

    <script type="module">
      const $ = (id) => document.getElementById(id);

      const votedKey = "jukebox_voted_ids";
      const getVoted = () => new Set(JSON.parse(localStorage.getItem(votedKey) || "[]"));
      const saveVoted = (set) => localStorage.setItem(votedKey, JSON.stringify([...set]));

      // NOTE: the line above MUST NOT end with a backtick. If you see one, remove it.

      function showToast(kind, html) {
        const t = $("toast");
        t.classList.remove("hidden");
        t.innerHTML = html;

        t.className = "mt-6 rounded-2xl p-4 text-sm ring-1";
        if (kind === "ok") t.classList.add("bg-[#1DB954]/10", "ring-[#1DB954]/30", "text-[#baf7cf]");
        else if (kind === "warn") t.classList.add("bg-yellow-400/10", "ring-yellow-400/30", "text-yellow-200");
        else t.classList.add("bg-red-500/10", "ring-red-500/30", "text-red-200");
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (c) => ({
          "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
        }[c]));
      }

      function msToMinSec(ms) {
        if (!ms && ms !== 0) return "";
        const s = Math.floor(ms / 1000);
        const m = Math.floor(s / 60);
        const r = s % 60;
        return `${m}:${String(r).padStart(2, "0")}`;
      }

      async function search() {
        const q = $("q").value.trim();
        if (q.length < 3) { $("results").innerHTML = ""; return; }

        $("results").innerHTML = `
          <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10 text-sm text-neutral-300">
            Searching‚Ä¶
          </div>
        `;

        try {
          const url = `https://itunes.apple.com/search?term=${encodeURIComponent(q)}&entity=song&limit=10`;
          const r = await fetch(url, { mode: "cors" });

          if (!r.ok) {
            $("results").innerHTML = `
              <div class="rounded-2xl bg-red-500/10 p-4 ring-1 ring-red-500/20 text-sm text-red-200">
                Search failed (${r.status}). Try again.
              </div>`;
            return;
          }

          const data = await r.json();

          const results = (data.results ?? []).map(t => ({
            trackId: t.trackId,
            trackName: t.trackName,
            artistName: t.artistName,
            collectionName: t.collectionName,
            artworkUrl100: t.artworkUrl100,
            trackTimeMillis: t.trackTimeMillis,
          }));

          if (results.length === 0) {
            $("results").innerHTML = `
              <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10 text-sm text-neutral-300">
                No results.
              </div>`;
            return;
          }

          $("results").innerHTML = results.map((t, i) => `
            <button
              class="group w-full text-left rounded-2xl bg-black/30 ring-1 ring-white/10 px-4 py-3 hover:bg-white/5 transition flex items-center gap-3"
              data-idx="${i}"
              type="button"
            >
              <img
                src="${escapeHtml(t.artworkUrl100 || "")}"
                alt=""
                class="h-12 w-12 rounded-lg ring-1 ring-white/10 bg-white/5 object-cover"
                loading="lazy"
              />
              <div class="min-w-0 flex-1">
                <div class="font-extrabold text-neutral-100 truncate group-hover:text-white">
                  ${escapeHtml(t.trackName)}
                </div>
                <div class="text-sm text-neutral-300 truncate">
                  ${escapeHtml(t.artistName)}${t.collectionName ? " ‚Ä¢ " + escapeHtml(t.collectionName) : ""}
                </div>
              </div>

              <div class="shrink-0 flex items-center gap-2">
                <span class="text-xs text-neutral-400">${t.trackTimeMillis ? msToMinSec(t.trackTimeMillis) : ""}</span>
                <span class="rounded-full bg-[#1DB954] px-4 py-2 text-xs font-extrabold text-black group-hover:brightness-110">
                  Request
                </span>
              </div>
            </button>
          `).join("");

          [...$("results").querySelectorAll("button[data-idx]")].forEach(btn => {
            btn.addEventListener("click", async () => {
              const track = results[Number(btn.getAttribute("data-idx"))];

              $("results").innerHTML = `
                <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10 text-sm text-neutral-300">
                  Submitting‚Ä¶
                </div>
              `;

              const requestedBy = "";

              const resp = await fetch("/api/request", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ...track, requestedBy })
              });

              if (!resp.ok) {
                // Try JSON (rate limit)
                try {
                  const j = await resp.json();
                  if (resp.status === 429 && j?.retryAfterMs != null) {
                    const secs = Math.ceil(j.retryAfterMs / 1000);
                    showToast("warn", `Rate limited ‚Äî try again in <b>${secs}s</b>.`);
                    $("results").innerHTML = "";
                    return;
                  }
                  showToast("err", `Request failed. ${escapeHtml(j?.error || JSON.stringify(j))}`);
                  return;
                } catch {
                  const txt = await resp.text().catch(() => "");
                  showToast("err", `Request failed. ${escapeHtml(txt)}`);
                  return;
                }
              }

              showToast("ok", `Requested: <b>${escapeHtml(track.trackName)}</b> ‚Äî ${escapeHtml(track.artistName)}`);
              $("results").innerHTML = "";
              await refreshRequests();
            });
          });

        } catch (err) {
          console.error(err);
          $("results").innerHTML = `
            <div class="rounded-2xl bg-red-500/10 p-4 ring-1 ring-red-500/20 text-sm text-red-200">
              Search blocked (CORS/network).
            </div>
          `;
        }
      }

      async function refreshRequests() {
        try {
          const r = await fetch("/api/requests?limit=50", { cache: "no-store" });
          const data = await r.json();
          const voted = getVoted();

          $("requests").innerHTML = (data.results || []).map(row => {
            const spotifySearch = `https://open.spotify.com/search/${encodeURIComponent(row.track_name + " " + row.artist_name)}`;
            const disabled = voted.has(row.id);
            const art = row.artwork_url || "";

            return `
              <div class="rounded-2xl bg-white/5 ring-1 ring-white/10 backdrop-blur px-4 py-3 flex items-center justify-between gap-4">
                <div class="flex items-center gap-3 min-w-0">
                  <img
                    src="${escapeHtml(art)}"
                    alt=""
                    class="h-12 w-12 rounded-lg bg-white/5 ring-1 ring-white/10 object-cover"
                    loading="lazy"
                  />
                  <div class="min-w-0">
                    <div class="font-extrabold text-neutral-100 truncate">${escapeHtml(row.track_name)}</div>
                    <div class="text-sm text-neutral-300 truncate">
                      ${escapeHtml(row.artist_name)}${row.album_name ? " ‚Ä¢ " + escapeHtml(row.album_name) : ""}
                    </div>
                    <a class="text-xs text-neutral-400 hover:text-neutral-200 underline underline-offset-2"
                      href="${spotifySearch}" target="_blank" rel="noreferrer">
                      Open in Spotify
                    </a>
                  </div>
                </div>

                <div class="flex items-center gap-3 shrink-0">
                  <div class="rounded-full bg-black/30 px-3 py-2 ring-1 ring-white/10 text-center">
                    <div class="text-[10px] uppercase tracking-wider text-neutral-400">votes</div>
                    <div class="text-lg font-black leading-none">${row.votes}</div>
                  </div>

                  <button
                    class="vote rounded-full px-4 py-2 text-sm font-extrabold transition
                      ${disabled
                        ? "bg-white/5 text-neutral-500 ring-1 ring-white/10 cursor-not-allowed"
                        : "bg-[#1DB954] text-black hover:brightness-110 active:brightness-95"}"
                    data-id="${row.id}"
                    ${disabled ? "disabled" : ""}
                    title="${disabled ? "You already voted" : "Vote"}"
                    type="button"
                  >
                    üëç
                  </button>
                </div>
              </div>
            `;
          }).join("");

          [...document.querySelectorAll("button.vote")].forEach(btn => {
            btn.addEventListener("click", async () => {
              const id = btn.getAttribute("data-id");
              const voted = getVoted();
              if (voted.has(id)) return;

              voted.add(id);
              saveVoted(voted);

              const resp = await fetch("/api/vote", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id })
              });

              if (!resp.ok) {
                voted.delete(id);
                saveVoted(voted);
                const txt = await resp.text().catch(() => "");
                showToast("err", `Vote failed. ${escapeHtml(txt)}`);
                return;
              }

              await refreshRequests();
            });
          });
        } catch (e) {
          console.error(e);
          $("requests").innerHTML = `
            <div class="rounded-2xl bg-red-500/10 p-4 ring-1 ring-red-500/20 text-sm text-red-200">
              Failed to load requests.
            </div>
          `;
        }
      }

      // Wire up events
      $("btnSearch").addEventListener("click", search);
      $("q").addEventListener("keydown", (e) => { if (e.key === "Enter") search(); });

      $("btnRefresh").addEventListener("click", async () => {
        await refreshRequests();
        showToast("ok", "Refreshed requests.");
      });

      // Initial load
      refreshRequests();
      setInterval(refreshRequests, 10000);
    </script>
  </body>
</Layout>

